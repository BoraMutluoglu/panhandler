{% extends 'pan_cnc/base.html' %}
{% load cnc_tags %}
{% load static %}
{% block head %}
    <link href="{% static 'css/highlight-atom-one-light.css' %}" rel="stylesheet">
    <script src="{% static 'js/highlight.pack.js' %}"></script>
    <style>
        .table td {
            border-top: 0px;
        }

        @media (min-width: 768px) {
            .modal-xl {
                width: 90%;
                max-width: 1200px;
            }
        }
    </style>
    <script type="text/javascript">
        var submit_lock = false;

        var skillet = JSON.parse('{{  skillet_json | escapejs }}');

        var skillet_variables = skillet['variables'];

        var declared_variables = JSON.parse('{{ skillet.declared_variables | tojson | escapejs }}');

        var skillet_snippets = JSON.parse('{{ skillet.snippet_stack | tojson | escapejs }}');

        var current_snippet_index = 0;

        function add_label(key, value) {
            let label_base = $('#label_base');
            let all_labels = $('#all_labels');
            let new_label = label_base.clone();
            let new_label_key = new_label.find('[data-label_type="key"]');
            let new_label_value = new_label.find('[data-label_type="value"]');

            new_label_key.val(key);
            new_label_value.val(value);

            new_label.prop('id', 'label_' + key + '_' + value)

            all_labels.append(new_label);

            new_label.css('display', '');
        }

        function add_new_label() {
            event.preventDefault();
            let new_label = $('#new_label_group');
            let new_label_key = new_label.find('[data-label_type="key"]');
            let new_label_value = new_label.find('[data-label_type="value"]');
            let key = new_label_key.val();
            let value = new_label_value.val();
            add_label(key, value);

            new_label_key.val('');
            new_label_value.val('');

            // go ahead and update our skillet obje
            update_all_labels();
        }

        function enlarge_text_area(target) {
            try {
                event.preventDefault();
            } catch (e) {
                console.log('no event to cancel');
            }

            let text_area_input = $('#text_area_input')
            let text_area_target_input = $('#text_area_target')
            text_area_target_input.val(target);

            let source_text_input = $('#' + target);
            let source_text = source_text_input.val();

            text_area_input.val(source_text);

            $('#show_textarea_modal').modal();
        }

        function update_text_area_source() {
            let text_area_input = $('#text_area_input')
            let text_area_target_input = $('#text_area_target')

            let target = text_area_target_input.val();
            let source_text_input = $('#' + target);
            source_text_input.val(text_area_input.val());
        }

        function update_pan_validation_snippet() {

            let snippet_name_input = $('#id_pan_validation_snippet_name');
            let snippet_cmd_input = $('#id_pan_validation_snippet_cmd');

            let snippet_name = snippet_name_input.val();
            let cmd = snippet_cmd_input.val();

            let snippet_def = get_snippet_definition(snippet_name);

            snippet_def['cmd'] = cmd;

            // set options for the given cmd
            switch (cmd) {

                case 'cli':
                    snippet_def['cmd_str'] = $('#id_pan_validation_snippet_cmd_cmd_str').val();

                    extract_variables(snippet_def['cmd_str']);
                    break;

                case 'op':
                    snippet_def['cmd_str'] = $('#id_pan_validation_snippet_cmd_op').val();
                    snippet_def['parse_result'] = $('#id_pan_validation_snippet_op_parse_result').val();
                    extract_variables(snippet_def['cmd_str']);
                    break;
            }

            update_snippet('pan_validation');
        }

        function update_panos_snippet() {

            let snippet_name_input = $('#id_panos_snippet_name');
            let snippet_cmd_input = $('#id_panos_snippet_cmd');

            let snippet_name = snippet_name_input.val();
            let cmd = snippet_cmd_input.val();

            let snippet_def = get_snippet_definition(snippet_name);

            snippet_def['cmd'] = cmd;

            // set options for the given cmd
            switch (cmd) {
                case 'set':
                    snippet_def['xpath'] = $('#id_panos_snippet_set_xpath').val();
                    snippet_def['element'] = $('#id_panos_snippet_set_element').val();

                    extract_variables(snippet_def['xpath']);
                    extract_variables(snippet_def['element']);
                    break;

                case 'get':
                    snippet_def['xpath'] = $('#id_panos_snippet_get_xpath').val();

                    extract_variables(snippet_def['xpath']);
                    break;

                case 'show':
                    snippet_def['xpath'] = $('#id_panos_snippet_show_xpath').val();

                    extract_variables(snippet_def['xpath']);
                    break;

                case 'delete':
                    snippet_def['xpath'] = $('#id_panos_snippet_delete_xpath').val();

                    extract_variables(snippet_def['xpath']);
                    break;

                case 'cli':
                    snippet_def['cmd_str'] = $('#id_panos_snippet_cmd_cmd_str').val();

                    extract_variables(snippet_def['cmd_str']);
                    break;

                case 'op':
                    snippet_def['cmd_str'] = $('#id_panos_snippet_cmd_op').val();
                    snippet_def['parse_result'] = $('#id_panos_snippet_op_parse_result').val();
                    extract_variables(snippet_def['cmd_str']);
                    break;

                case 'parse':
                    snippet_def['variable'] = $('#id_panos_snippet_variable').val();
                    break;
            }

            $('#panos_outputs_add').removeClass('show');

            // update the snippet UI list to have the new cmd
            let this_snippet_div = $('#snippet_' + snippet_name);
            this_snippet_div.find('[data-snippet_attribute="type"]').val(snippet_def['cmd']);

            update_snippet('panos');
        }

        function edit_output(output_div) {
            /**
             * Called from the output_base div to edit this output definition. Will grab all the values and
             * put them back in the 'add output' fields then delete itself
             * See https://gitlab.com/panw-gse/as/panhandler/-/issues/24 GL #24
             *
             */

            let output_type = skillet['type'];

            let output_div_obj = $(output_div).closest('[id^=output_]');
            let name_span = output_div_obj.find('[data-output_attribute_type="name"]');
            let capture_type_span = output_div_obj.find('[data-output_attribute_type="key"]');
            let capture_value_span = output_div_obj.find('[data-output_attribute_type="value"]');
            let capture_filter_span = output_div_obj.find('[data-output_attribute_type="filter"]');

            let name = name_span.html();
            let capture_key = capture_type_span.html();
            let capture_value = capture_value_span.html();
            let capture_filter = capture_filter_span.html();

            let outputs_add_el = $('#' + output_type + '_outputs_add')
            outputs_add_el.show();

            let opt_name_field = $('#id_' + output_type + '_output_name');
            let opt_key_field = $('#id_' + output_type + '_output_key');
            let opt_val_field = $('#id_' + output_type + '_output_value');
            let opt_filter_field = $('#id_' + output_type + '_output_filter');

            if (capture_key === 'capture_list') {
                opt_filter_field.closest('.form-group').show();
            } else {
                opt_filter_field.closest('.form-group').hide();
                opt_filter_field.val('');
            }

            opt_name_field.val(name);
            opt_key_field.val(capture_key);
            opt_val_field.val(capture_value);
            opt_filter_field.val(capture_filter);

            output_div_obj.remove();

            opt_name_field.effect('highlight');
            opt_key_field.effect('highlight');
            opt_val_field.effect('highlight');
        }

        function add_update_variable() {
            /**
             * Add or update the variable entry in the global skillet_variables variable
             */
            event.preventDefault();
            let new_variable_key = $('#id_variable_name');
            let new_variable_value = $('#id_variable_type');
            let new_variable_default = $('#id_variable_default');
            let new_variable_description = $('#id_variable_description');
            let new_variable_help = $('#id_variable_help_text');

            let var_name = new_variable_key.val();
            let var_type_hint = new_variable_value.val();
            let var_default = new_variable_default.val();
            let var_description = new_variable_description.val();
            let var_help_text = new_variable_help.val();

            new_variable_key.val('');
            new_variable_value.val('text');
            new_variable_description.val('');
            new_variable_default.val('');
            new_variable_help.val('');

            let edit_var_op = $('#id_variable_operation').val();

            let variable_def = get_variable_definition(var_name);

            if (typeof variable_def !== 'undefined') {
                if (edit_var_op === 'add') {
                    // this name exists and user has requested an 'add' operation
                    // we will not allow user to add a variable when we already have one with that name
                    alert('That variable name already exists');
                    return;
                } else {
                    // this is an update operation
                    variable_def['default'] = var_default;
                    variable_def['description'] = var_description;
                    variable_def['type_hint'] = var_type_hint;
                    variable_def['help_text'] = var_help_text;

                    get_variable_type_hint_options(variable_def);

                    // ensure we update the summary view as well in case description has changed
                    let this_var_div = $('#variable_' + var_name);
                    this_var_div.find('[data-variable_attribute="type"]').val(var_description);

                    return;
                }
            } else {
                // variable does not exist, create a def now
                variable_def = {
                    'name': var_name,
                    'type_hint': var_type_hint,
                    'description': var_description,
                    'default': var_default,
                    'help_text': var_help_text,
                }
            }

            // ensure we grab type specific items and add to the variable_definition
            get_variable_type_hint_options(variable_def);

            // push this new variable onto the skillet_variables global variable
            skillet_variables.push(variable_def);

            // add the variable to the UI
            add_variable(var_name, var_description);
        }

        function update_all_labels() {
            /**
             * Grab all the currently display labels and update the skillet variable appropriately
             */

            let new_labels = {};

            let labels_div = $('#all_labels');
            labels_div.find('.input-group').each(function (index, obj) {
                let label_group = $(obj);
                let label_key = label_group.find('[data-label_type="key"]').val();
                let label_value = label_group.find('[data-label_type="value"]').val();

                if (typeof new_labels[label_key] === 'undefined') {
                    new_labels[label_key] = label_value;
                } else if (typeof new_labels[label_key] === 'string') {
                    let orig_value = new_labels[label_key];
                    let label_key_list = [];
                    label_key_list.push(orig_value);
                    label_key_list.push(label_value);
                    new_labels[label_key] = label_key_list;
                } else if ($.isArray(new_labels[label_key])) {
                    new_labels[label_key].push(label_value);
                }
            });

            skillet['labels'] = new_labels;
        }

        function update_all_variables() {
            /**
             * Update the skillet_variables global var to be reflective of the UI
             */

            let all_variables = [];
            let vars_div = $('#all_variables');

            vars_div.find('.input-group').each(function (index, obj) {
                let variable_group = $(obj);
                let variable_name = variable_group.find('[data-variable_attribute="name"]').val();
                let variable_def = get_variable_definition(variable_name);
                all_variables.push(variable_def);
            });

            skillet_variables = all_variables;

        }

        function update_all_snippets() {
            /**
             * Update the skillet_snippets global var to be reflective of the UI
             */

            let all_snippets = [];
            let vars_div = $('#all_snippets');

            vars_div.find('.input-group').each(function (index, obj) {
                let snippet_group = $(obj);
                let snippet_name = snippet_group.find('[data-snippet_attribute="name"]').val();
                let snippet_def = get_snippet_definition(snippet_name);
                all_snippets.push(snippet_def);
            });

            skillet_snippets = all_snippets;

        }

        function get_variable_type_hint_options(variable_definition) {
            /**
             * Get variable type_hint specific options
             */
            switch (variable_definition['type_hint']) {
                case 'text':
                    break;
                case 'dropdown':
                    let options_object = $('#all_dropdown_options');
                    let dd_list = [];
                    options_object.find('.input-group').each(function (index, object) {
                        let dropdown_option_group = $(object);
                        let option_key = dropdown_option_group.find('[data-dropdown_option_type="key"]').val();
                        let option_value = dropdown_option_group.find('[data-dropdown_option_type="value"]').val();
                        dd_list.push({'key': option_key, 'value': option_value});
                    });
                    variable_definition['dd_list'] = dd_list;
                    break;

                case 'checkbox':
                    let cbx_object = $('#all_checkbox_options');
                    let cbx_list = [];
                    cbx_object.find('.input-group').each(function (index, object) {
                        let checkbox_option_group = $(object);
                        let option_key = checkbox_option_group.find('[data-checkbox_option_type="key"]').val();
                        let option_value = checkbox_option_group.find('[data-checkbox_option_type="value"]').val();
                        cbx_list.push({'key': option_key, 'value': option_value});
                    });
                    variable_definition['cbx_list'] = cbx_list;
                    break;

                case 'radio':
                    let rad_object = $('#all_radio_options');
                    let rad_list = [];
                    rad_object.find('.input-group').each(function (index, object) {
                        let radio_option_group = $(object);
                        let option_key = radio_option_group.find('[data-radio_option_type="key"]').val();
                        let option_value = radio_option_group.find('[data-radio_option_type="value"]').val();
                        rad_list.push({'key': option_key, 'value': option_value});
                    });
                    variable_definition['rad_list'] = rad_list;
                    break;
            }
        }

        function is_pan_type_skillet() {

            return (['panos', 'panorama', 'panorama-gpcs'].indexOf(skillet['type']) >= 0);
        }

        function setup_variable_type_hint_options(variable_definition) {

            // first, remove any options that may be present
            clean_up_variable_type_hint_options();

            switch (variable_definition['type_hint']) {
                case 'text':
                    break;
                case 'dropdown':
                    $.each(variable_definition['dd_list'], function (index, list_option) {
                        add_option(list_option['key'], list_option['value'], 'dropdown');
                    });
                    break;

                case 'checkbox':
                    $.each(variable_definition['cbx_list'], function (index, list_option) {
                        add_option(list_option['key'], list_option['value'], 'checkbox');
                    });
                    break;

                case 'radio':
                    $.each(variable_definition['rad_list'], function (index, list_option) {
                        add_option(list_option['key'], list_option['value'], 'radio');
                    });
                    break;
            }
        }

        function clean_up_variable_type_hint_options() {
            /**
             * Clean up and remove all previously configured type_hint options
             */

                // clean up dropdown options
            let options_object = $('#all_dropdown_options');
            options_object.find('.input-group').each(function (index, object) {
                let dropdown_option_group = $(object);
                dropdown_option_group.remove();
            });

            // clean up checkbox options
            let cbx_object = $('#all_checkbox_options');
            cbx_object.find('.input-group').each(function (index, object) {
                let option_group = $(object);
                option_group.remove();
            });

            // clean up radio options
            let rad_object = $('#all_radio_options');
            rad_object.find('.input-group').each(function (index, object) {
                let option_group = $(object);
                option_group.remove();
            });
        }

        function add_variable(key, value) {
            let variable_base = $('#variable_base');
            let all_variables = $('#all_variables');
            let new_variable = variable_base.clone();
            let new_variable_key = new_variable.find('[data-variable_attribute="name"]');
            let new_variable_value = new_variable.find('[data-variable_attribute="type"]');

            new_variable_key.val(key);
            new_variable_value.val(value);

            new_variable.attr('id', 'variable_' + key);
            all_variables.append(new_variable);

            new_variable.css('display', '');
        }

        function remove_variable(var_object) {
            event.preventDefault();
            let variable_to_remove_link = $(var_object);
            let variable_to_remove = variable_to_remove_link.closest('.input-group');
            variable_to_remove.remove();

        }

        function add_new_snippet() {

            let snippet_name = $('#id_new_snippet_name').val();
            let snippet_def = {};
            snippet_def['name'] = snippet_name;

            if (is_pan_type_skillet()) {
                snippet_def['cmd'] = 'set';
                snippet_def['xpath'] = '';
                snippet_def['element'] = '';

            } else if (skillet['type'] === 'template') {
                snippet_def['element'] = '';
            }

            if (skillet_snippets.findIndex(i => i.name === snippet_name) === -1) {
                skillet_snippets.push(snippet_def);
                add_snippet(snippet_name);
                edit_snippet_by_name(snippet_name);

            } else {
                alert('Snippet with that name already exists!');
            }

        }

        function add_snippet(key) {
            let snippet_base = $('#snippet_base');
            let all_snippets = $('#all_snippets');
            let new_snippet = snippet_base.clone();
            let new_snippet_key = new_snippet.find('[data-snippet_attribute="name"]');

            let snippet = get_snippet_definition(key);
            new_snippet_key.val(key);
            let new_snippet_type = new_snippet.find('[data-snippet_attribute="type"]');

            if ((is_pan_type_skillet()) || (skillet['type'] === 'pan_validation')) {
                new_snippet_type.val(snippet['cmd']);
            } else {
                new_snippet_type.val('');
            }

            all_snippets.append(new_snippet);

            new_snippet.css('display', '');
            new_snippet.attr('id', 'snippet_' + key);
        }

        function remove_option(option_object) {
            event.preventDefault();
            let option_to_remove_link = $(option_object);
            let option_to_remove = option_to_remove_link.closest('.input-group');
            option_to_remove.remove();
        }

        function remove_tag(tag_object) {
            event.preventDefault();
            let tag_to_remove_link = $(tag_object);
            let tag_to_remove = tag_to_remove_link.closest('.input-group');
            tag_to_remove.remove();
        }

        function remove_snippet(option_object) {
            remove_option(option_object);
            update_all_snippets();
        }

        function remove_output(output_object) {
            event.preventDefault();
            let output_to_remove_link = $(output_object);
            let output_to_remove = output_to_remove_link.closest('.bg-light');
            output_to_remove.remove();
        }

        function get_variable_definition(var_name) {
            let var_def = undefined;
            $.each(skillet_variables, function (index, variable) {
                let vn = variable["name"];
                if (vn === var_name) {
                    console.log('found a match!');
                    // jquery .each uses return false as a 'break' for the loop
                    var_def = variable;
                    return false;
                }
            });

            return var_def;
        }

        function get_snippet_definition(snippet_name) {
            /**
             * Iterate the skillet_snippets global variable
             * and find the dictionary with a matching 'name' attribute
             * skillet_snippets is set from the skillet_json object passed from server side
             */
            let snippet_def = undefined;
            $.each(skillet_snippets, function (index, snippet) {
                let vn = snippet["name"];
                if (vn === snippet_name) {
                    console.log('found a match!');
                    // jquery .each uses return false as a 'break' for the loop
                    snippet_def = snippet;
                    return false;
                }
            });

            return snippet_def;
        }

        function show_add_variable() {
            /**
             * Set up and show the Add Variable Modal
             */

            let var_modal_name_field = $('#id_variable_name');
            var_modal_name_field.prop('disabled', '');
            var_modal_name_field.val('new_variable');

            $('#id_variable_description').val('Human Readable Label');
            $('#id_variable_default').val('default value');
            $('#id_variable_type').val('text');

            let edit_variable_modal = $('#edit_variable_modal');

            // Since we re-use the same dialog for both add and edit, let's set a hidden flag
            // to indicate if this should be an edit or an add operation
            let edit_var_op = $('#id_variable_operation');
            edit_var_op.val('add');

            let submit_button = $('#edit_var_submit_btn');
            submit_button.html('Add');

            // remove all previously set options, if any
            clean_up_variable_type_hint_options();

            edit_variable_modal.modal();
            setup_modal_options();
        }

        function show_edit_variable(variable_object) {
            /**
             * Set up and show the Edit Variable Modal dialog
             */
            event.preventDefault();
            let variable_edit_link = $(variable_object);
            let var_group = variable_edit_link.closest('.input-group');
            let var_name_field = var_group.find('[data-variable_attribute="name"]');
            let var_name = var_name_field.val();
            console.log(var_name);
            let variable_def = get_variable_definition(var_name);
            console.log(variable_def);

            let var_modal_name_field = $('#id_variable_name');
            var_modal_name_field.prop('disabled', 'disabled');
            var_modal_name_field.val(var_name);

            $('#id_variable_description').val(variable_def['description']);
            $('#id_variable_default').val(variable_def['default']);
            $('#id_variable_type').val(variable_def['type_hint']);
            $('#id_variable_help_text').val(variable_def['help_text']);

            let edit_variable_modal = $('#edit_variable_modal');

            // Since we re-use the same dialog for both add and edit, let's set a hidden flag
            // to indicate if this should be an edit or an add operation
            let edit_var_op = $('#id_variable_operation');
            edit_var_op.val('update');

            let submit_button = $('#edit_var_submit_btn');
            submit_button.html('Update');

            setup_variable_type_hint_options(variable_def);

            edit_variable_modal.modal();
            setup_modal_options();

        }

        function setup_snippet_modal(snippet_def, skillet_type) {
            // blank out all pre-existing options
            $('#edit_' + skillet_type + '_snippet_modal').find('.form-control').val('');

            // set output capture var name to full_output by default
            $('#id_' + skillet_type + '_output_name').val('raw_output');
            // set output capture type to pattern by default
            $('#id_' + skillet_type + '_output_key').val('capture_pattern');
            // set output capture pattern to pattern by default
            $('#id_' + skillet_type + '_output_value').val('.');


            // remove all existing output options, if any
            $('#all_' + skillet_type + '_output_options').empty();

            // remove all existing tags, if any
            $('#all_' + skillet_type + '_tags').empty();

            // set the snippet name
            $('#id_' + skillet_type + '_snippet_name').val(snippet_def['name']);

            // set up new_name field if found
            let new_name_field = $('#id_' + skillet_type + '_snippet_new_name');
            if (typeof(new_name_field) !== 'undefined') {
                new_name_field.val(snippet_def['name']);
            }

            // output type of text can only have 1 output defined and capture_type does not matter, just fill in
            // a default though it will be ignored anyway.
            if (snippet_def['output_type'] === 'text') {
                if ('outputs' in snippet_def) {
                    let output_object = snippet_def['outputs'][0];
                    add_output(output_object['name'], 'capture_pattern', '.', skillet_type);
                }
            } else {
                // show output definitions
                $(snippet_def['outputs']).each(function (index, output_object) {
                    let capture_type = 'capture_list';
                    if ('capture_pattern' in output_object) {
                        capture_type = 'capture_pattern';
                    } else if ('capture_value' in output_object) {
                        capture_type = 'capture_value';
                    } else if ('capture_object' in output_object) {
                        capture_type = 'capture_object';
                    }

                    if ('filter_items' in output_object) {
                        add_filtered_output(output_object['name'], capture_type, output_object[capture_type],
                            output_object['filter_items'], skillet_type);
                    } else {
                        add_output(output_object['name'], capture_type, output_object[capture_type], skillet_type);
                    }
                });
            }

            // setup tags if present
            $(snippet_def['tags']).each(function (index, tag_value) {
                add_tag(tag_value, skillet_type);
            });

            for (let attribute_name in snippet_def) {
                let z = $('#id_' + skillet_type + '_snippet_' + attribute_name);
                if (z.length) {
                    z.val(snippet_def[attribute_name]);
                }
            }
        }

        function setup_rest_snippet(snippet_def) {
            setup_snippet_modal(snippet_def, 'rest');
        }

        function setup_pan_validation_snippet(snippet_def) {

            setup_snippet_modal(snippet_def, 'pan_validation');
            switch (snippet_def['cmd']) {

                case 'cli':
                    $('#id_pan_validation_snippet_cmd_cmd_str').val(snippet_def['cmd_str']);
                    break;

                case 'op':
                    $('#id_pan_validation_snippet_cmd_op').val(snippet_def['cmd_str']);

                    if (typeof snippet_def['parse_result'] === 'undefined') {
                        snippet_def['parse_result'] = 'True';
                    }

                    $('#id_pan_validation_snippet_op_parse_result').val(snippet_def['parse_result']);
                    break;
            }

        }

        function update_and_edit_next_snippet(snippet_type) {
            /**
             *  Called by the Edit Snippet Modal. This will save the current snippet from the UI
             *  find the next snippet and load that modal
             */

            if (is_pan_type_skillet(snippet_type)) {
                update_panos_snippet();
            } else if (snippet_type === 'pan-validation') {
                update_pan_validation_snippet();
            } else {
                update_snippet(snippet_type);
            }

            let snippet_name_input = $('#id_' + snippet_type.replace('-', '_') + '_snippet_name');
            let snippet_name = snippet_name_input.val();
            let current_snippet_index = skillet_snippets.findIndex(i => i.name === snippet_name);
            let next_snippet = skillet_snippets[current_snippet_index + 1];
            if (typeof next_snippet === 'undefined') {
                // no more snippets to edit, hide the modal and return here
                $('#edit_' + snippet_type + '_snippet_modal').modal('hide');
                return;
            }

            edit_snippet_by_name(next_snippet['name']);
        }

        function update_snippet(snippet_type) {
            let snippet_name_input = $('#id_' + snippet_type + '_snippet_name');
            let snippet_name = snippet_name_input.val();

            let snippet_def = get_snippet_definition(snippet_name);
            for (let attribute_name in snippet_def) {
                let z = $('#id_' + snippet_type + '_snippet_' + attribute_name);
                if (z.length) {
                    snippet_def[attribute_name] = z.val();

                    extract_variables(snippet_def[attribute_name]);
                }
            }

            snippet_def['when'] = $('#id_' + snippet_type + '_snippet_when').val();

            snippet_def['outputs'] = [];
            $('#all_' + snippet_type + '_output_options').find('[id^="output_"]').each(function (index, output_div) {
                let output_div_obj = $(output_div);
                let name_span = output_div_obj.find('[data-output_attribute_type="name"]');
                let capture_type_span = output_div_obj.find('[data-output_attribute_type="key"]');
                let capture_value_span = output_div_obj.find('[data-output_attribute_type="value"]');
                let capture_filter_span = output_div_obj.find('[data-output_attribute_type="filter"]');

                let name = name_span.html();
                let capture_key = capture_type_span.html();
                let capture_value = capture_value_span.html();
                let capture_filter = capture_filter_span.html();

                let output_def = {};
                output_def['name'] = name;
                output_def[capture_key] = capture_value;

                if ((typeof capture_filter !== 'undefined') && (capture_filter !== '')) {
                    output_def['filter_items'] = capture_filter;
                }

                snippet_def['outputs'].push(output_def);
            });

            // fix for #1 - do not add blank attributes
            if (snippet_def['outputs'] === []) {
                delete snippet_def['outputs'];
            }
            // don't add blank str attributes - this can happen when changing snippet cmd types
            for (let attribute_name in snippet_def) {
                if (snippet_def[attribute_name] === '') {
                    delete snippet_def[attribute_name];
                }
            }

            // capture all configured tags
            let new_tags = [];
            $('#all_' + snippet_type + '_tags').find('[id^="tag_' + snippet_type + '_"]').each(
                function (index, tag_div) {
                    let tag_div_obj = $(tag_div);
                    let tag_input = tag_div_obj.find('[data-tag_type="tag"]');
                    let tag_value = tag_input.val();
                    new_tags.push(tag_value);
                });

            if (new_tags.length > 0) {
                snippet_def['tags'] = new_tags;
            }

            let new_snippet_name_input = $('#id_' + snippet_type + '_snippet_new_name');
            if (typeof(new_snippet_name_input) !== 'undefined') {
                let new_snippet_name = new_snippet_name_input.val();

                if (new_snippet_name !== snippet_name) {
                    snippet_def['name'] = new_snippet_name;
                    // ensure we update the summary view as well in case description has changed
                    let this_snippet_div = $('#snippet_' + snippet_name);
                    this_snippet_div.find('[data-snippet_attribute="name"]').val(new_snippet_name);
                    this_snippet_div.attr('id', 'snippet_' + new_snippet_name);
                }
            }
        }

        function setup_panos_snippet(snippet_def) {
            // set the snippet cmd
            if (typeof snippet_def['cmd'] === 'undefined') {
                snippet_def['cmd'] = 'set';
            }

            $('#id_panos_snippet_cmd').val(snippet_def['cmd']);

            if ((typeof snippet_def['output_type'] !== 'undefined') && (snippet_def['output_type'] !== '')) {
                $('#id_panos_snippet_output_type').val(snippet_def['output_type']);
            } else {
                $('#id_panos_snippet_output_type').val('xml');
            }

            if ((typeof snippet_def['when'] !== 'undefined') && (snippet_def['when'] !== '')) {
                $('#id_panos_snippet_when').val(snippet_def['when']);
            } else {
                $('#id_panos_snippet_when').val('');
            }

            setup_snippet_modal(snippet_def, 'panos');

            $('#id_panos_snippet_output_type').val('xml');
            // set output capture type to list by default
            $('#id_panos_output_key').val('capture_object');
            // set output capture type to list by default
            $('#id_panos_output_value').val('.');
            // set output capture type to list by default
            $('#id_panos_output_name').val('full_output_as_object');

            // always start with the main tab
            $('#panos_main_tab').tab('show');
            // set options for the given cmd
            switch (snippet_def['cmd']) {
                case 'set':
                    $('#id_panos_snippet_set_xpath').val(snippet_def['xpath']);
                    $('#id_panos_snippet_set_element').val(snippet_def['element']);
                    break;

                case 'get':
                    $('#id_panos_snippet_get_xpath').val(snippet_def['xpath']);
                    break;

                case 'show':
                    $('#id_panos_snippet_show_xpath').val(snippet_def['xpath']);
                    break;

                case 'delete':
                    $('#id_panos_snippet_delete_xpath').val(snippet_def['xpath']);
                    break;

                case 'cli':
                    $('#id_panos_snippet_cmd_cmd_str').val(snippet_def['cmd_str']);
                    break;

                case 'op':
                    $('#id_panos_snippet_cmd_op').val(snippet_def['cmd_str']);

                    if (typeof snippet_def['parse_result'] === 'undefined') {
                        snippet_def['parse_result'] = 'True';
                    }

                    $('#id_panos_snippet_op_parse_result').val(snippet_def['parse_result']);
                    break;
            }
        }

        function show_edit_snippet(snippet_object) {
            event.preventDefault();
            let snippet_edit_link = $(snippet_object);
            let snippet_group = snippet_edit_link.closest('.input-group');
            let snippet_name_field = snippet_group.find('[data-snippet_attribute="name"]');

            let snippet_name = snippet_name_field.val();
            edit_snippet_by_name(snippet_name);
        }

        function edit_snippet_by_name(snippet_name) {
            let snippet_def = get_snippet_definition(snippet_name);
            if (is_pan_type_skillet()) {
                setup_panos_snippet(snippet_def);
                $('#edit_panos_snippet_modal').modal();
            } else if (skillet['type'] === 'pan_validation') {
                setup_pan_validation_snippet(snippet_def);
                $('#edit_pan_validation_snippet_modal').modal();
            } else if (skillet['type'] === 'rest') {
                setup_rest_snippet(snippet_def);
                $('#edit_rest_snippet_modal').modal();
            } else if (skillet['type'] === 'panorama-gpcs') {
                // FIXME -
                setup_snippet_modal(snippet_def, 'panos');
                $('#edit_panos_snippet_modal').modal();
            } else {
                let m = $('#edit_' + skillet['type'] + '_snippet_modal');
                if (m.length) {
                    setup_snippet_modal(snippet_def, skillet['type']);
                    m.modal();
                } else {
                    alert('Snippet type not yet implemented!');
                    return;
                }
            }
            setup_modal_options();
        }

        function update_text_variable() {
            event.preventDefault();
            let name = $('#id_text_variable_name').val();
            let description = $('#id_text_variable_description').val();
            let var_default = $('#id_text_variable_default').val();

            let variable_def = get_variable_definition(name);
            variable_def["name"] = name;
            variable_def["description"] = description;
            variable_def["default"] = var_default;

            let var_ui = $('#variable_' + name);
            let var_ui_name = var_ui.find('[data-variable_attribute="name"]');
            var_ui_name.val(name);
        }

        function toggle_modal_options(object_id) {
            /**
             * Called when Edit Snippet is called. Shows and hides the appropriate fields
             * and also sets up onchange listeners for each snippet option for the source object value
             * For example, panos type snippet cmd == 'set' should have 'xpath' shown, but not 'cmd_str'
             */
            let source_value = $('#' + object_id).val();
            $('[data-modal_source="' + object_id + '"]').each(function (i, e) {
                let this_object = $(e);
                let parent = $(e).closest('.form-group');
                let data_value_array = this_object.data('modal_value').split(',');
                let found = false;
                $(data_value_array).each(function (indx, data_value) {
                    if (data_value === source_value) {
                        parent.show();
                        found = true;
                    }
                });
                if (! found) {
                    parent.hide();
                }
            });
        }

        function setup_modal_options() {
            /**
             * Called each time a snippet modal is opened to ensure each field is properly display / hidden
             */

            $('[data-modal_source][data-modal_value]').each(function (i, e) {
                // hide everything at first
                $(e).closest('.form-group').hide();
            });


            $('[data-modal_source][data-modal_value]').each(function (i, e) {
                // iterate over all dom elements that have both a data-modal_source and data-modal_value attribute
                // get this object as the input object
                let input_object = $(e);
                // get our source id, i.e. what triggers a change on this
                let source_object_id = input_object.attr('data-modal_source');
                // get the source object
                let source_object = $('#' + source_object_id);
                // get it's current value
                let source_value = source_object.val();

                // set up event listeners on the source so trigger when things change
                source_object.change(function () {
                    toggle_modal_options(this.id);
                });

                // get the closes dom element with a 'form-group' class
                let parent = input_object.closest('.form-group');

                // get the modal_value data and split it on a ',' - this allows more than one input source to trigger
                let data_value_array = input_object.data('modal_value').split(',');

                // iterate over each item in the data_value_array
                $(data_value_array).each(function (indx, data_value) {
                    // if any match, show the parent form-group and break
                    if (data_value === source_value) {
                        parent.show();
                        // .each does not have a break, but return false is the equivelent in jquery
                        return false;
                    }
                });
            });
        }

        function add_option(opt_key, opt_value, option_type) {
            let option_base = $('#' + option_type + '_option_base');
            let all_options = $('#all_' + option_type + '_options');
            let new_option = option_base.clone();
            let new_option_key = new_option.find('[data-' + option_type + '_option_type="key"]');
            let new_option_value = new_option.find('[data-' + option_type + '_option_type="value"]');

            new_option_key.val(opt_key);
            new_option_value.val(opt_value);

            all_options.append(new_option);

            new_option.css('display', '');
        }

        function add_new_option(option_type) {
            /**
             * Called from adding a new option from the snippet modal - checkbox, radio, or dropdown options
             */
            event.preventDefault();
            let opt_key_field = $('#id_' + option_type + '_key');
            let opt_val_field = $('#id_' + option_type + '_value');

            let opt_key = opt_key_field.val();
            let opt_val = opt_val_field.val();

            add_option(opt_key, opt_val, option_type);

            opt_key_field.val('');
            opt_val_field.val('');

            opt_key_field.focus();
        }

        function add_tag(tag_value, tag_type) {
            let tag_base = $('#tag_base');
            let all_tags = $('#all_' + tag_type + '_tags');
            let new_tag = tag_base.clone();
            let new_tag_value = new_tag.find('[data-tag_type="tag"]');

            new_tag_value.val(tag_value);

            all_tags.append(new_tag);

            new_tag.prop('id', 'tag_' + tag_type + '_' + tag_value);
            new_tag.css('display', '');
        }

        function add_new_tag(tag_type) {
            /**
             * Called from adding a new tag from the snippet modal
             */
            event.preventDefault();
            let tag_field = $('#id_' + tag_type + '_tag');

            let tag_val = tag_field.val();

            add_tag(tag_val, tag_type);

            tag_field.val('');

            tag_field.focus();
        }

        function add_output(output_name, output_key, output_value, output_type) {
            let output_base = $('#output_base');
            let all_outputs = $('#all_' + output_type + '_output_options');

            let new_output = output_base.clone();
            let new_output_name = new_output.find('[data-output_attribute_type="name"]');
            let new_output_key = new_output.find('[data-output_attribute_type="key"]');
            let new_output_value = new_output.find('[data-output_attribute_type="value"]');

            new_output_name.html(output_name);
            new_output_key.html(output_key);
            new_output_value.html(output_value);

            all_outputs.append(new_output);

            new_output.prop('id', 'output_' + output_name);
            new_output.css('display', '');
        }

        function add_filtered_output(output_name, output_key, output_value, filter_expression, output_type) {
            let output_base = $('#filtered_output_base');
            let all_outputs = $('#all_' + output_type + '_output_options');

            let new_output = output_base.clone();
            let new_output_name = new_output.find('[data-output_attribute_type="name"]');
            let new_output_key = new_output.find('[data-output_attribute_type="key"]');
            let new_output_value = new_output.find('[data-output_attribute_type="value"]');
            let new_output_filter = new_output.find('[data-output_attribute_type="filter"]');

            new_output_name.html(output_name);
            new_output_key.html(output_key);
            new_output_value.html(output_value.replace('\n', ''));
            new_output_filter.html(filter_expression);

            all_outputs.append(new_output);

            new_output.prop('id', 'output_' + output_name);
            new_output.css('display', '');
        }

        function add_new_output(output_type) {
            /**
             * Called from adding a new snippet output capture
             */
            event.preventDefault();
            let opt_name_field = $('#id_' + output_type + '_output_name');
            let opt_key_field = $('#id_' + output_type + '_output_key');
            let opt_val_field = $('#id_' + output_type + '_output_value');

            let opt_key = opt_key_field.val();
            let opt_val = opt_val_field.val();
            let opt_name = opt_name_field.val();

            if (opt_key === 'capture_list') {

                let opt_filter_field = $('#id_' + output_type + '_output_filter');
                let filter_expression = opt_filter_field.val();

                if ((typeof filter_expression !== 'undefined') && (filter_expression !== '')) {
                    add_filtered_output(opt_name, opt_key, opt_val, filter_expression, output_type);
                    opt_filter_field.val('');
                } else {
                    add_output(opt_name, opt_key, opt_val, output_type);
                }

            } else {
                add_output(opt_name, opt_key, opt_val, output_type);
            }

            opt_name_field.val('');
            {#opt_key_field.val('');#}
            opt_val_field.val('.');

            opt_name_field.focus();
        }

        function update_preamble() {
            /**
             * Update Skillet Preamble information
             */

            let skillet_id_input = $('#id_skillet_id');
            let skillet_label_input = $('#id_skillet_label');
            let skillet_description_input = $('#id_skillet_description');

            if (skillet_id_input.val() !== skillet['name']) {
                skillet_id_input.effect('highlight');
                skillet['name'] = skillet_id_input.val();
            }

            if (skillet_label_input.val() !== skillet['label']) {
                skillet_label_input.effect('highlight');
                skillet['label'] = skillet_label_input.val();
            }
            if (skillet_description_input.val() !== skillet['description']) {
                skillet_description_input.effect('highlight');
                skillet['description'] = skillet_description_input.val();
            }

            // fix for GL #1 - remove empty attributes from skillet
            if (('depends' in skillet) && (skillet['depends'].length === 0)) {
                delete skillet['depends'];
            }

            console.log(skillet);
        }

        function show_skillet() {

            let json_output_control = $('#skillet_json_output');

            // always grab latest labels
            update_all_labels();

            delete skillet['snippet_path'];

            skillet['variables'] = skillet_variables;
            skillet['snippets'] = skillet_snippets;

            json_output_control.val(JSON.stringify(skillet, null, '  '));

            $('#show_skillet_modal').modal();
        }

        function show_test_skillet() {

            let context_object = $('#id_test_skillet_context');
            let initial_context = {};

            if (skillet['type'].startsWith('pan')) {
                initial_context['ip_address'] = '10.10.10.10';
                initial_context['username'] = 'admin';
                initial_context['password'] = 'admin';
            }

            $.each(skillet_variables, function (index, v) {
                initial_context[v.name] = v.default;
            });

            if (context_object.val() === '') {
                context_object.val(JSON.stringify(initial_context, null, '  '));
            }
            current_snippet_index = 0;
            let next_snippet = skillet_snippets[current_snippet_index];

            if (typeof (next_snippet) === 'undefined') {
                alert('No Snippets found for debug');
                return;
            }

            let id_test_skillet_next_input = $('#id_test_skillet_next');
            id_test_skillet_next_input.val(next_snippet['name']);

            let id_test_skillet_raw_json_input = $('#id_test_skillet_raw_json');
            id_test_skillet_raw_json_input.val(JSON.stringify(next_snippet, null, '  '));

            $('#step_over_skillet_button').show();
            $('#step_over_next_button').show();

            // set up the skip ahead dropdown
            let id_test_skillet_skip = $('#id_test_skillet_skip_to');
            id_test_skillet_skip.empty();

            $.each(skillet_snippets, function (i, item) {
                $('#id_test_skillet_skip_to').append($('<option>', {
                    value: item.name,
                    text: item.name,
                }));
            });

            $('#show_test_skillet_modal').modal();

        }

        function show_test_snippet() {

            let context_object = $('#id_test_snippet_context');

            let initial_context = {};
            if (context_object.val() !== '') {
                try {
                    initial_context = JSON.parse(context_object.val());
                } catch (e) {
                    initial_context = {};
                }
            }

            if (skillet['type'].startsWith('pan')) {
                if (!('ip_address' in initial_context)) {
                    initial_context['ip_address'] = '10.10.10.10';
                    initial_context['username'] = 'admin';
                    initial_context['password'] = 'admin';
                }

                if (skillet['type'] === 'pan-validation') {
                    update_snippet('pan-validation');
                } else {
                    update_panos_snippet();
                }

            } else {
                update_snippet(skillet['type']);
            }

            $.each(skillet_variables, function (index, v) {
                console.log('checking ' + v.name);
                initial_context[v.name] = v.default;
            });

            context_object.val(JSON.stringify(initial_context, null, '  '));

            $('#show_test_snippet_modal').modal();

        }

        function extract_variables(template_str) {
            /**
             * Post the template_str to app server to extract any defined jinja2 variables. Any found variables
             * will be checked if we already know about them and added to the UI and the skillet_variables list if
             * not. Do not consider empty template strings or ones that do not include a jinja open variable syntax
             */

            // skip if blank
            if (template_str === '') {
                return;
            }

            // skip if no jinja variable syntax found
            if (!template_str.includes('{% templatetag openvariable %}')) {
                console.log('skipping ' + template_str);
                return;
            }

            $.ajax({
                method: "POST",
                url: "/panhandler/extract_variables",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                contentType: "application/json",
                dataType: "json",
                async: false,
                data: JSON.stringify({"template_str": template_str})
            })
                .fail(function (message) {
                    alert('error');
                    console.log(message)
                })
                .done(function (data) {
                    add_all_variables(data);
                });
        }

        function test_skillet() {
            /**
             * Post the skillet to app server to execute and test the skillet. Only works on 'pan' type skillets
             * for now.
             */

            let doc = $(document.documentElement);
            doc.css('cursor', 'progress');

            update_skillet_from_ui();

            let context_input = $('#id_test_skillet_context');
            let context = context_input.val();

            let context_var = {};
            try {
                context_var = JSON.parse(context);
            } catch (e) {
                alert('Could not convert Context into proper JSON!');
                return false;
            }

            let results_input = $('#id_test_skillet_results');

            results_input.val('Contacting Device ... ');

            $.ajax({
                method: "POST",
                url: "/panhandler/test_skillet",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({"skillet": skillet, "context": context_var})
            })
                .fail(function (message) {
                    alert('error');
                    console.log(message);
                    doc.css('cursor', '');
                })
                .done(function (data) {
                    let results = JSON.stringify(data, null, '  ');
                    doc.css('cursor', '');
                    let results_code = $('#id_test_skillet_results_code');
                    results_code.html(results);

                    $('#show_test_skillet_results_modal').modal();

                    hljs.highlightBlock(results_code[0]);

                });
        }

        function step_over_restart_skillet() {
            /**
             * Reset the current snippet to test in the test_skillet modal
             */
            current_snippet_index = 0;
            $('#step_over_skillet_button').show();
            $('#step_over_next_button').show();
            let id_test_skillet_next_input = $('#id_test_skillet_next');
            let next_snippet = skillet_snippets[current_snippet_index];
            id_test_skillet_next_input.val(next_snippet['name']);

            let id_test_skillet_raw_json_input = $('#id_test_skillet_raw_json');
            id_test_skillet_raw_json_input.val(JSON.stringify(next_snippet, null, '  '));

            let outputs_input = $('#id_test_skillet_outputs');
            outputs_input.val('');
        }

        function step_over_skillet_next() {
            /**
             * Skip the 'next' snippet in the skillet debugger
             */
            current_snippet_index += 1;
            let id_test_skillet_next_input = $('#id_test_skillet_next');

            if (id_test_skillet_next_input.val() === 'running...') {
                console.log('skipping running check');
                return;
            }
            let current_snippet = id_test_skillet_next_input.val();

            let next_snippet = skillet_snippets[current_snippet_index];

            if (typeof next_snippet === 'undefined') {
                $('#step_over_skillet_button').hide();
                $('#step_over_next_button').hide();
                id_test_skillet_next_input.val('Completed');
                current_snippet_index = 0;
                return;
            }

            id_test_skillet_next_input.val(next_snippet['name']);

            let id_test_skillet_raw_json_input = $('#id_test_skillet_raw_json');
            id_test_skillet_raw_json_input.val(JSON.stringify(next_snippet, null, '  '));

            let outputs_input = $('#id_test_skillet_outputs');
            outputs_input.val('Skipped ' + current_snippet);
        }


        function step_over_snippet_skip_to() {
            let id_test_skillet_skip_to = $('#id_test_skillet_skip_to');
            let id_test_skillet_next_input = $('#id_test_skillet_next');

            let desired_snippet = id_test_skillet_skip_to.val();

            current_snippet_index = skillet_snippets.findIndex(i => i.name === desired_snippet);
            let next_snippet = skillet_snippets[current_snippet_index];
            id_test_skillet_next_input.val(next_snippet['name']);

            let id_test_skillet_raw_json_input = $('#id_test_skillet_raw_json');
            id_test_skillet_raw_json_input.val(JSON.stringify(next_snippet, null, '  '));

            let outputs_input = $('#id_test_skillet_outputs');
            outputs_input.val('Skipped ahead to ' + next_snippet['name']);
            $('#step_over_skillet_button').show();
            $('#step_over_next_button').show();
        }

        function step_over_skillet() {
            /**
             * Post the skillet to app server to execute and test the skillet. Only works on 'pan' type skillets
             * for now.
             */

            let id_test_skillet_next_input = $('#id_test_skillet_next');
            if (id_test_skillet_next_input.val() === 'running...') {
                console.log('skipping running check');
                return;
            }

            let doc = $(document.documentElement);
            doc.css('cursor', 'progress');

            update_skillet_from_ui();

            let context_input = $('#id_test_skillet_context');
            let context = context_input.val();

            let context_var = {};
            try {
                context_var = JSON.parse(context);
            } catch (e) {
                alert('Could not convert Context into proper JSON!');
                return false;
            }
            let current_snippet = skillet_snippets[current_snippet_index];
            let test_skillet = skillet;

            test_skillet['snippets'] = [current_snippet];

            current_snippet_index += 1;


            let next_snippet = skillet_snippets[current_snippet_index];

            if (typeof next_snippet === 'undefined') {
                $('#step_over_next_button').hide();
                $('#step_over_skillet_button').hide();
                id_test_skillet_next_input.val('Completed');
                current_snippet_index = 0;
            } else {
                id_test_skillet_next_input.val('running...');
            }

            let outputs_input = $('#id_test_skillet_outputs');
            outputs_input.val('debugging...');

            $.ajax({
                method: "POST",
                url: "/panhandler/test_skillet",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({"skillet": test_skillet, "context": context_var})
            })
                .fail(function (message) {
                    alert('error');
                    console.log(message);
                    doc.css('cursor', '');
                })
                .done(function (data) {
                    doc.css('cursor', '');
                    let context = JSON.stringify(data['context'], null, '  ');
                    let output = JSON.stringify(data['output'], null, '  ');

                    if (typeof (next_snippet) !== 'undefined') {
                        id_test_skillet_next_input.val(next_snippet['name']);

                        let id_test_skillet_raw_json_input = $('#id_test_skillet_raw_json');
                        id_test_skillet_raw_json_input.val(JSON.stringify(next_snippet, null, '  '));
                    }

                    console.log(context);
                    let context_input = $('#id_test_skillet_context');
                    let outputs_input = $('#id_test_skillet_outputs');

                    let err = JSON.stringify(data['error'], null, '   ');

                    if (typeof (err) !== 'undefined') {
                        outputs_input.val(err);
                    } else {
                        outputs_input.val(output);
                    }

                    context_input.val(context);
                    context_input.effect('highlight');
                    outputs_input.effect('highlight');
                });
        }

        function test_snippet() {
            /**
             * Post the snippet to app server to execute and test the snippet. Only works on 'pan' type skillets
             * for now.
             */

            let doc = $(document.documentElement);
            doc.css('cursor', 'progress');

            let snippet_name = '';
            if (is_pan_type_skillet()) {
                snippet_name = $('#id_panos_snippet_name').val();
            } else if (skillet['type'] === 'pan-validation') {
                snippet_name = $('#id_pan_validation_snippet_name').val();
            } else {
                doc.css('cursor', '');
                alert('Unsupported Skillet type for Snippet Debug');
                return false;
            }

            update_skillet_from_ui();

            let context_input = $('#id_test_snippet_context');
            let context = context_input.val();

            let context_var = {};
            try {
                context_var = JSON.parse(context);
            } catch (e) {
                alert('Could not convert Context into proper JSON!');
                return false;
            }

            let results_input = $('#id_test_skillet_results');

            results_input.val('Contacting Device ... ');

            let test_skillet = skillet;
            let snippet = get_snippet_definition(snippet_name);

            if (!(['get', 'show', 'parse', 'op'].indexOf(snippet['cmd']) >= 0)) {
                doc.css('cursor', '');
                alert('Snippet Debug only supported for get, show, and parse commands');
                return false;
            }

            test_skillet['snippets'] = [snippet];

            $.ajax({
                method: "POST",
                url: "/panhandler/test_skillet",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({"skillet": test_skillet, "context": context_var})
            })
                .fail(function (message) {
                    alert('error');
                    console.log(message);
                    doc.css('cursor', '');
                })
                .done(function (data) {
                    let results = JSON.stringify(data, null, '  ');
                    doc.css('cursor', '');
                    let results_code = $('#id_test_skillet_results_code');
                    results_code.html(results);

                    $('#show_test_skillet_results_modal').modal();

                    hljs.highlightBlock(results_code[0]);

                });
        }

        function cancel_test_snippet() {

            let snippet_name = '';
            if (is_pan_type_skillet()) {
                snippet_name = $('#id_panos_snippet_name').val();
            } else {
                snippet_name = $('id_pan_validation_snippet_name').val();
            }

            edit_snippet_by_name(snippet_name);
        }

        function add_all_variables(variable_list) {
            /**
             * Iterate the list of variables and ensure we have them all in the skillet_variables list
             * and add them to the UI if not. Also, check all other snippets to ensure a variable isn't
             * just an output from another snippet, in which case we don't
             */
            $.each(variable_list, function (index, declared_variable) {
                let found_as_output = false;
                console.log('checking ' + declared_variable);
                $.each(skillet_snippets, function (index, object) {
                    console.log('checking var ' + object.name);
                    if ('outputs' in object) {
                        console.log('we have outputs here');
                        if (object['outputs'].findIndex(i => i.name === declared_variable) === -1) {
                            console.log('not found in this output');
                            return true;
                        } else {
                            console.log('found as an output');
                            found_as_output = true;
                            // stop iteration here
                            return false;
                        }
                    } else {
                        console.log('no outputs here');
                        // continue iteration
                        return true;
                    }
                });
                console.log('was it found?')
                console.log(found_as_output)
                if (found_as_output === true) {

                    // skip this variable
                    console.log('found as output');
                    return true;
                }

                if (skillet_variables.findIndex(i => i.name === declared_variable) === -1) {
                    let new_var = {};
                    new_var['name'] = declared_variable;
                    new_var['description'] = declared_variable;
                    new_var['type_hint'] = 'text';
                    new_var['default'] = '';
                    skillet_variables.push(new_var);

                    add_variable(declared_variable, 'text');
                }
            });
        }

        function save_raw_skillet() {
            /**
             *  Used to save raw skillet data from a text input instead of having to use the menu structures
             */
            let raw_skillet_input = $('#skillet_json_output');
            let json_output_control = $('#id_skillet_contents');

            json_output_control.val(raw_skillet_input.val());
            let doc = $(document.documentElement);
            doc.css('cursor', 'progress');

            $('#raw_skillet_save_button').prop('disabled', true);
            $('#submit_button').prop("disabled", true);
            $('#dynamic_form').submit();

        }

        function save_skillet() {
            /**
             * uploads the skillet json to Panhandler
             */
            let json_output_control = $('#id_skillet_contents');

            update_skillet_from_ui();

            json_output_control.val(JSON.stringify(skillet, null, '  '));

            let doc = $(document.documentElement);
            doc.css('cursor', 'progress');

            $('#submit_button').prop("disabled", true);
            $('#dynamic_form').submit();

        }

        function update_skillet_from_ui() {
            /**
             * Update the Skillet global variable from the UI elements
             */
            update_preamble();
            update_all_variables();
            update_all_snippets();
            update_all_labels();

            skillet['variables'] = skillet_variables;
            skillet['snippets'] = skillet_snippets;

        }

        function slugify(text) {
            /**
             * Clean up text
             * modified from source: https://gist.github.com/mathewbyrne/1280286
             */
            return text.toString().toLowerCase()
                .replace(/\s+/g, '_')           // Replace spaces with _
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\_\_+/g, '_')         // Replace multiple _ with single _
                .replace(/^_+/, '')             // Trim _ from start of text
                .replace(/_+$/, '');            // Trim _ from end of text
        }

        function text_area_find_replace() {
            /**
             * Text Edit Modal find and replace
             */

            let editor_text_input = $('#text_area_input');
            let editor_text_find = $('#text_area_input_find');
            let editor_text_replace = $('#text_area_input_replace');

            let editor_text = editor_text_input.val();
            let find_text = editor_text_find.val();
            let replace_text_raw = slugify(editor_text_replace.val());
            let replace_text = '{% templatetag openvariable %} ' + replace_text_raw +
                ' {% templatetag closevariable %}';

            editor_text_input.val(editor_text.replace(new RegExp(find_text, 'g'), replace_text));

            editor_text_find.val('');
            editor_text_replace.val('');

            editor_text_input.effect('highlight');

        }

        $(document).ready(function () {
            let label_vals = JSON.parse('{{ skillet.labels | tojson | safe }}');
            console.log(label_vals);

            console.log(skillet_snippets);

            $.each(label_vals, function (key, value) {
                if (typeof value == 'string') {
                    add_label(key, value);
                } else if (value instanceof Array) {
                    $.each(value, function (i, v) {
                        add_label(key, v);
                    });
                } else {
                    console.log('Unsupported label type!');
                }

            });

            console.log(skillet_variables);

            let variable_base = $('#variable_base');
            let all_variables = $('#all_variables');
            let all_snippets = $('#all_snippets');

            // each Skillet will collect all the variables that have been defined
            // we can compare this with the variables the user has added to the skillet
            // and add them if necessary
            $.each(declared_variables, function (index, declared_variable) {
                if (skillet_variables.findIndex(i => i.name === declared_variable) === -1) {
                    let new_var = {};
                    new_var['name'] = declared_variable;
                    new_var['description'] = 'Undeclared Variable';
                    new_var['type_hint'] = 'text';
                    new_var['default'] = '';
                    skillet_variables.push(new_var);
                }
            });

            $.each(skillet_variables, function (index, variable) {

                let new_variable = variable_base.clone();
                let new_variable_key = new_variable.find('[data-variable_attribute="name"]');
                let new_variable_value = new_variable.find('[data-variable_attribute="type"]');

                new_variable_key.val(variable["name"]);
                new_variable_value.val(variable["description"]);

                new_variable.attr('id', 'variable_' + variable["name"]);
                all_variables.append(new_variable);

                new_variable.css('display', '');
            });

            $.each(skillet_snippets, function (index, snippet) {
                let snippet_base = $('#snippet_base');
                let new_snippet = snippet_base.clone();
                let new_snippet_key = new_snippet.find('[data-snippet_attribute="name"]');
                let new_snippet_type = new_snippet.find('[data-snippet_attribute="type"]');
                new_snippet_key.val(snippet['name']);

                if ((is_pan_type_skillet()) || (skillet['type'] === 'pan_validation')) {
                    new_snippet_type.val(snippet['cmd']);
                } else {
                    new_snippet_type.val('');
                }

                new_snippet.attr('id', 'snippet_' + new_snippet_key.val());

                all_snippets.append(new_snippet);

                new_snippet.css('display', '');

            });

            setup_modal_options();

            all_variables.sortable({
                handle: '.input-group-prepend',
                tolerance: "pointer",
                containment: 'parent',
                update: function (event, ui) {
                    let updated_vars = [];
                    all_variables.find('[data-variable_attribute="name"]').each(function (index, object) {
                        let var_input = $(object);
                        let var_name = var_input.val();
                        let this_var_def = get_variable_definition(var_name);
                        updated_vars.push(this_var_def);
                    });
                    skillet_variables = updated_vars;
                }
            });

            all_snippets.sortable({
                handle: '.input-group-prepend',
                containment: 'parent',
                tolerance: "pointer",
                update: function () {
                    let updated_snippets = [];
                    all_snippets.find('[data-snippet_attribute="name"]').each(function (index, object) {
                        let snippet_input = $(object);
                        let snippet_name = snippet_input.val();
                        let this_snippet_def = get_snippet_definition(snippet_name);
                        updated_snippets.push(this_snippet_def);
                    });
                    skillet_snippets = updated_snippets;
                }
            })
        });
    </script>
{% endblock %}
{% block content %}
    <div class="card border-primary mb-5 shadow-lg rounded">
        <div class="card-header">
            Skillet Editor
            <div class="float-right">
                <a href="#" onclick="show_skillet();" title="Edit Raw Skillet">
                    <i class="fas fa-edit text-primary mr-1"></i>
                </a>
                {% if view.help_text and view_help_text != '' %}
                    <a href="#" data-toggle="modal" data-target="#helpTextModal" title="Help">
                        <i class="fas fa-question-circle text-primary mr-1"></i>
                    </a>
                {% elif view.service.description and view.service.description != '' %}
                    <a href="#" data-toggle="modal" data-target="#helpTextModal" title="Help">
                        <i class="fas fa-question-circle text-primary mr-1"></i>
                    </a>
                {% endif %}
            </div>

        </div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="id_skillet_id">Name:</label>
                    <input type="text" name="skillet_id" value="{{ skillet.name }}" class="form-control"
                           id="id_skillet_id" title="Skillet ID">
                </div>
                <div class="form-group col-md-4">
                    <label for="id_skillet_label">Label:</label>
                    <input type="text" name="skillet_label" value="{{ skillet.label }}" class="form-control"
                           id="id_skillet_label">
                </div>
                <div class="form-group col-md-4">
                    <label for="id_skillet_type">Type:</label>
                    <input type="text" name="skillet_type" value="{{ skillet.type }}" class="form-control"
                           id="id_skillet_type" disabled="disabled">
                </div>
            </div>
            <div class="form-group mb-4">
                <label for="id_skillet_description">Description:</label>
                <textarea name="skillet_description" cols="50" rows="3" class="form-control"
                          id="id_skillet_description">{{ skillet.description }}</textarea>
            </div>
            <hr/>
            <div class="form-group mb-4">
                <div id="all_labels">
                    <label for="all_labels_group">Labels:</label>
                </div>
                <div id="new_label" class="text-right">
                    <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                            data-target="#add_label_modal">Add Label
                    </button>
                </div>
            </div>
            <hr/>
            <div class="form-group">
                <label for="all_variables">Variables:</label>
                <div id="all_variables">
                </div>
                <div id="new_variable" class="text-right">
                    <button type="button" class="btn btn-outline-primary" onclick="show_add_variable();">
                        Add Variable
                    </button>
                </div>
            </div>
            <hr/>
            <div class="form-group">
                <label for="all_snippets">Snippets:</label>
                <div id="all_snippets">
                </div>
                <div id="new_snippet" class="text-right">
                    <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                            data-target="#show_new_snippet_modal">Add Snippet
                    </button>
                </div>
            </div>
            <hr/>
            <p class="card-text">
            <form action="{{ action }}" id="dynamic_form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% include 'pan_cnc/bootstrap_form.html' with form=form %}
            </form>
            </p>
        </div>
        <div class="card-footer text-right">
            <button type="button" class="btn btn-success" onclick="show_test_skillet()">
                Debug
            </button>
            <a href="/cancel" class="btn btn-danger">Cancel</a>
            <button type="button" class="btn btn-primary" onclick="save_skillet()">
                Save
            </button>
        </div>
    </div>
    {% include 'pan_cnc/help_text_modal.html' %}

    <!-- Label Clone -->
    <div class="input-group mb-3" id="label_base" style="display: none">
        <input type="text" value=""
               data-label_type="key" class="form-control bg-light" disabled="disabled"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-label_type="value" class="form-control bg-light" disabled="disabled"/>
        <div class="input-group-append">
                <span class="input-group-text">
                    <a href="#" onclick="remove_option(this);">
                        <i class="fa fa-minus"></i>
                    </a>
                </span>
        </div>
    </div>

    <!-- Variable Clone -->
    <div class="input-group mb-3" id="variable_base" style="display: none">
        <div class="input-group-prepend">
            <span class="input-group-text" title="Drag to Sort">
                    <i class="fa fa-sort"></i>
            </span>
        </div>
        <input type="text" value=""
               data-variable_attribute="name" class="form-control bg-light" disabled="disabled"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-variable_attribute="type" class="form-control bg-light" disabled/>
        <div class="input-group-append">
            <span class="input-group-text" title="Remove Variable">
                <a href="#" onclick="remove_variable(this);">
                    <i class="fa fa-minus"></i>
                </a>
            </span>
            <span class="input-group-text" title="Edit Variable">
                <a href="#" onclick="show_edit_variable(this);">
                    <i class="fa fa-edit"></i>
                </a>
            </span>
        </div>
    </div>

    <!-- Snippet Clone -->
    <div class="input-group mb-3" id="snippet_base" style="display: none">
        <div class="input-group-prepend">
                <span class="input-group-text" title="Drag to Sort">
                        <i class="fa fa-sort"></i>
                </span>
        </div>
        <input type="text" value=""
               data-snippet_attribute="name" class="form-control bg-light" disabled="disabled"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-snippet_attribute="type" class="form-control bg-light" disabled/>
        <div class="input-group-append">
            <span class="input-group-text" title="Remove Snippet">
                <a href="#" onclick="remove_snippet(this);">
                    <i class="fa fa-minus"></i>
                </a>
            </span>
            <span class="input-group-text">
                <a href="#" onclick="show_edit_snippet(this);">
                    <i class="fa fa-edit"></i>
                </a>
            </span>
        </div>
    </div>

    <!-- Dropdown Option Clone -->
    <div class="input-group mb-3" id="dropdown_option_base" style="display: none">
        <input type="text" value=""
               data-dropdown_option_type="key" class="form-control"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-dropdown_option_type="value" class="form-control"/>
        <div class="input-group-append">
                <span class="input-group-text">
                    <a href="#" onclick="remove_option(this);">
                        <i class="fa fa-minus"></i>
                    </a>
                </span>
        </div>
    </div>

    <!-- Checkbox Option Clone -->
    <div class="input-group mb-3" id="checkbox_option_base" style="display: none">
        <input type="text" value=""
               data-checkbox_option_type="key" class="form-control"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-checkbox_option_type="value" class="form-control"/>
        <div class="input-group-append">
                <span class="input-group-text">
                    <a href="#" onclick="remove_option(this);">
                        <i class="fa fa-minus"></i>
                    </a>
                </span>
        </div>
    </div>

    <!-- Radio Option Clone -->
    <div class="input-group mb-3" id="radio_option_base" style="display: none">
        <input type="text" value=""
               data-radio_option_type="key" class="form-control"/>
        <div class="input-group-append"><span class="input-group-text">:</span></div>
        <input type="text" value=""
               data-radio_option_type="value" class="form-control"/>
        <div class="input-group-append">
                <span class="input-group-text">
                    <a href="#" onclick="remove_option(this);">
                        <i class="fa fa-minus"></i>
                    </a>
                </span>
        </div>
    </div>

    <!-- Output Definitions Clone -->
    <div id="output_base" style="display: none" class="bg-light mb-0 w-100 mt-1 p-1">
        <div class="float-right">
            <a href="#" class="p2" onclick="edit_output(this);">
                <i class="fa fa-edit"></i>
            </a>
            <a href="#" class="p2" onclick="remove_output(this);">
                <i class="fa fa-times"></i>
            </a>
        </div>
        <pre class="mb-0"><code class="yaml"> - name: <span data-output_attribute_type="name"></span>
   <span data-output_attribute_type="key"></span>: <span data-output_attribute_type="value"></span></code></pre>
    </div>

    <!-- Filtered Output Definitions Clone OLD -->
    <div id="filtered_output_base" style="display: none" class="bg-light mb-0 w-100 mt-1 p-1">
        <div class="float-right">
            <a href="#" class="p2" onclick="edit_output(this);">
                <i class="fa fa-edit"></i>
            </a>
            <a href="#" class="p2" onclick="remove_output(this);">
                <i class="fa fa-times"></i>
            </a>
        </div>
        <pre class="mb-0"><code class="yaml"> - name: <span data-output_attribute_type="name"></span>
   <span data-output_attribute_type="key"></span>: <span data-output_attribute_type="value"></span>
   <span>filter_items</span>: <span data-output_attribute_type="filter"></span></code></pre>
    </div>

    <!-- Tags Clone -->
    <div class="input-group mb-3" id="tag_base" style="display: none">
        <input type="text" value=""
               data-tag_type="tag" class="form-control"/>
        <div class="input-group-append">
                <span class="input-group-text">
                    <a href="#" onclick="remove_tag(this);">
                        <i class="fa fa-minus"></i>
                    </a>
                </span>
        </div>
    </div>

    <!-- Add Label Modal -->
    <div class="modal fade" id="add_label_modal" tabindex="-1" role="dialog" aria-labelledby="add_label_label"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add_label_label">Add Label</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <label for="new_label_group">Add Label:</label>
                    <div class="input-group" id="new_label_group">
                        <input type="text" name="label_key" value=""
                               data-label_type="key" class="form-control" id="id_labels_key">
                        <div class="input-group-append"><span class="input-group-text">:</span></div>
                        <input type="text" name="label_value" value=""
                               data-label_type="value" class="form-control" id="id_labels_value">
                        <div class="input-group-append">
                                <span class="input-group-text">
                                    <a href="#" onclick="add_new_label();">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Variable modal -->
    <div class="modal fade" id="edit_variable_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_variable_label"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_variable_label">Edit Variable</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <input type="hidden" value="update" class="form-control" id="id_variable_operation">
                    <label for="id_variable_name">Name:</label>
                    <input type="text" value="" class="form-control" id="id_variable_name">
                    <label for="id_variable_description">Description:</label>
                    <input type="text" value="" class="form-control" id="id_variable_description"
                           title="Human friendly description for this variable.">
                    <label for="id_variable_help_text">Help Text:</label>
                    <input type="text" value="" class="form-control" id="id_variable_help_text"
                           title="Contextual help information for this variable.">
                    <label for="id_variable_default">Default:</label>
                    <input type="text" value="" class="form-control" id="id_variable_default"
                           title="Default value that will be used if no input is supplied by the user.">
                    <label for="id_variable_type">Variable Type:</label>
                    <select class="form-control" id="id_variable_type"
                            title="This controls how this variable will be displayed to the user.">
                        <option value="text">Text</option>
                        <option value="text_area">Text Area</option>
                        <option value="password">Password</option>
                        <option value="dropdown">Dropdown Select</option>
                        <option value="checkbox">Checkbox Select</option>
                        <option value="radio">Radio Select</option>
                        <option value="number">Integer</option>
                        <option value="float">Float</option>
                        <option value="fqdn_or_ip">FQDN</option>
                        <option value="ip_address">IP Address</option>
                        <option value="cidr">CIDR (IP with Netmask)</option>
                        <option value="file">File Upload</option>
                        <option value="hidden">Hidden</option>
                        <option value="disabled">Disabled</option>
                    </select>
                    <!-- Dropdown Items -->
                    <div class="form-group">
                        <label for="all_dropdown_options">Dropdown Items:</label>
                        <div class="input-group" id="all_dropdown_options"></div>
                        <hr/>
                        <label for="dropdown_options_add_ui">New Dropdown List Item</label>
                        <div class="input-group" id="dropdown_options_add_ui">
                            <input type="text" value="" placeholder="key" class="form-control" id="id_dropdown_key"
                                   data-modal_source="id_variable_type" data-modal_value="dropdown"
                                   title="This key will be what is set in the snippet context and available for templates.">
                            <div class="input-group-append"><span class="input-group-text">:</span></div>
                            <input type="text" value="" placeholder="value" class="form-control" id="id_dropdown_value"
                                   title="This value is what will be shown to the user in the dropdown menu.">
                            <div class="input-group-append">
                                <span class="input-group-text">
                                    <a href="#" onclick="add_new_option('dropdown');">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Checkbox items -->
                    <div class="form-group">
                        <label for="all_checkbox_options">Checkbox Items:</label>
                        <div class="input-group" id="all_checkbox_options"></div>
                        <hr/>
                        <label for="checkbox_options_add_ui">Add Item to Checkbox List:</label>
                        <div class="input-group" id="checkbox_options_add_ui">
                            <input type="text" value="" placeholder="key" class="form-control" id="id_checkbox_key"
                                   data-modal_source="id_variable_type" data-modal_value="checkbox">
                            <div class="input-group-append"><span class="input-group-text">:</span></div>
                            <input type="text" value="" placeholder="value" class="form-control" id="id_checkbox_value">
                            <div class="input-group-append">
                                <span class="input-group-text">
                                    <a href="#" onclick="add_new_option('checkbox');">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- Radio items -->
                    <div class="form-group">
                        <label for="all_radio_options">Radio Items:</label>
                        <div class="input-group" id="all_radio_options"></div>
                        <hr/>
                        <label for="radio_options_add_ui">Add Item to Radio List:</label>
                        <div class="input-group" id="radio_options_add_ui">
                            <input type="text" value="" placeholder="key" class="form-control" id="id_radio_key"
                                   data-modal_source="id_variable_type" data-modal_value="radio">
                            <div class="input-group-append"><span class="input-group-text">:</span></div>
                            <input type="text" value="" placeholder="value" class="form-control" id="id_radio_value">
                            <div class="input-group-append">
                                <span class="input-group-text">
                                    <a href="#" onclick="add_new_option('radio');">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="add_update_variable()"
                            id="edit_var_submit_btn"
                            data-dismiss="modal">
                        Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Variable of type Text Modal -->
    <div class="modal fade" id="edit_text_variable_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_text_variable_label"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_text_variable_label">Edit Text Variable</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <label for="id_text_variable_name">Name:</label>
                    <input type="text" value="" class="form-control" id="id_text_variable_name" disabled>
                    <label for="id_text_variable_description">Description:</label>
                    <input type="text" value="" class="form-control" id="id_text_variable_description">
                    <label for="id_text_variable_default">Default:</label>
                    <input type="text" value="" class="form-control" id="id_text_variable_default">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="update_text_variable()"
                            data-dismiss="modal">Update
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- Show Skillet Modal -->
    <div class="modal fade" id="show_skillet_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_skillet_label"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="show_skillet_label">Skillet JSON</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <textarea class="form-control text-monospace small"
                              style="width: 1200px; font-size: 80%" rows="20" id="skillet_json_output"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" id="raw_skillet_save_button" class="btn btn-primary"
                            onclick="save_raw_skillet()"
                            data-dismiss="modal">Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit PANOS Snippet Modal -->
    <div class="modal fade" id="edit_panos_snippet_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_panos_snippet_label"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_panos_snippet_modal_label">Edit PAN-OS Snippet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="panos_main_tab" data-toggle="tab" href="#panos_main"
                               role="tab"
                               aria-controls="panos_main"
                               aria-selected="true">Snippet</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="panos_when_tab" data-toggle="tab" href="#panos_when" role="tab"
                               aria-controls="panos_when"
                               aria-selected="false">When</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="panos_outputs_tab" data-toggle="tab" href="#panos_outputs"
                               role="tab"
                               aria-controls="panos_outputs"
                               aria-selected="false">Outputs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="panos_tags_tab" data-toggle="tab" href="#panos_tags"
                               role="tab"
                               aria-controls="panos_tags"
                               aria-selected="false">Tags</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="panos_snippet_tab">
                        <div class="tab-pane fade show active" id="panos_main" role="tabpanel"
                             aria-labelledby="panos_main_tab">

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="id_panos_snippet_name">Name:</label>
                                    <input type="hidden" value="" id="id_panos_snippet_name">
                                    <input type="text" value="" class="form-control"
                                           id="id_panos_snippet_new_name">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="id_panos_snippet_cmd">Command:</label>
                                    <select class="form-control" id="id_panos_snippet_cmd" title="cmd">
                                        <option>cli</option>
                                        <option>delete</option>
                                        <option>get</option>
                                        <option>move</option>
                                        <option>op</option>
                                        <option>parse</option>
                                        <option>set</option>
                                        <option>show</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="id_panos_snippet_set_xpath">XPath:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_set_xpath"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="set">
                                <label for="id_panos_snippet_set_element">Element:</label>
                                <textarea class="form-control" id="id_panos_snippet_set_element"
                                    rows="10"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" onclick="enlarge_text_area('id_panos_snippet_set_element')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_move_xpath">XPath:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_move_xpath"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="move">
                                <label for="id_panos_snippet_move_where">Where:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_move_where">
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_get_xpath">XPath:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_get_xpath"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="get">
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_show_xpath">XPath:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_show_xpath"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="show">
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_delete_xpath">XPath:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_delete_xpath"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="delete">
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_cmd_cmd_str">CLI:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_cmd_cmd_str"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="cli">
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_cmd_op">Operational Command XML:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_cmd_op"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="op">
                                <label for="id_panos_snippet_op_parse_result">Parse Result:</label>
                                <select id="id_panos_snippet_op_parse_result" class="form-control"
                                        title="Attempt to parse the returned XML document">
                                    <option selected>True</option>
                                    <option>False</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_variable">Parsed Variable:</label>
                                <input type="text" value="" class="form-control" id="id_panos_snippet_variable"
                                       data-modal_source="id_panos_snippet_cmd" data-modal_value="parse">
                            </div>
                        </div>

                        <div class="tab-pane fade" id="panos_when" role="tabpanel" aria-labelledby="panos_when_tab">
                            <div class="text-right mt-1">
                                <a href="#panos_when_help" data-toggle="collapse" title="When Conditional Help">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </div>
                            <div class="card card-body collapse mt-2 mb-2 bg-light" id="panos_when_help">
                                The 'when' conditional is a boolean jinja expression that determines whether this
                                snippet
                                should execute or not. Any expression evaluating to 'false' will cause this snippet
                                to be skipped and execution to pass to the next snippet in line.
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_when">When:</label>
                                <textarea class="form-control" id="id_panos_snippet_when"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" title="Expand View"
                                       onclick="enlarge_text_area('id_panos_snippet_when')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="panos_tags" role="tabpanel" aria-labelledby="panos_tags_tab">
                            <div class="text-right mt-1">
                                <a href="#panos_tags_help" data-toggle="collapse" title="Tags Help">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </div>
                            <div class="card card-body collapse mt-2 mb-2 bg-light" id="panos_tags_help">
                                Tags allow grouping like snippets together. This is useful for sorting outputs,
                                including or excluding groups of snippets or adding additional information to the
                                user.
                            </div>
                            <div class="form-group">
                                <label for="all_panos_tags">Tag List</label>
                                <div class="input-group" id="all_panos_tags"></div>
                                <hr/>
                                <label for="panos_tags_add_ui">Add New Tag To List</label>
                                <div class="input-group" id="panos_tags_add_ui">
                                    <input type="text" value="" placeholder="tag" class="form-control"
                                           id="id_panos_tag">
                                    <div class="input-group-append">
                                        <span class="input-group-text">
                                            <a href="#" onclick="add_new_tag('panos');">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="tab-pane fade" id="panos_outputs" role="tabpanel"
                             aria-labelledby="panos_outputs_tab">
                            <div class="text-right mt-1">
                                <a href="#panos_outputs_help" data-toggle="collapse" title="Outputs Help">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </div>
                            <div class="card card-body collapse mt-2 mb-2 bg-light" id="panos_outputs_help">
                                Outputs parse the data returned from the snippet. How that data is parsed depends on
                                the
                                'Output Type'. The 'name' attribute will create a new variable with that name that
                                can
                                then be referenced in later snippets. The 'capture_type' determines how the data
                                will
                                be processed. For example, a 'capture_list' will always return a list with 0 or more
                                elements while 'capture_value' will always return a single value. The 'Query'
                                is the query that will be used to parse the returned data. For 'xml' type data, this
                                is
                                an xpath query.
                            </div>
                            <div class="form-group">
                                <label for="id_panos_snippet_output_type">Output Type:</label>
                                <select id="id_panos_snippet_output_type" class="form-control">
                                    <option selected>xml</option>
                                    <option>json</option>
                                    <option>text</option>
                                </select>
                            </div>

                            <!-- Outputs -->
                            <div class="form-group">
                                <label for="all_panos_output_options">Outputs:</label>
                                <div class="input-group" id="all_panos_output_options"></div>
                            </div>
                            <hr/>
                            <a href="#panos_outputs_add" data-toggle="collapse" data-target="#panos_outputs_add"
                               aria-expanded="true" aria-controls="panos_outputs_add">
                                <i class="fa fa-plus"></i>Add Output
                            </a>
                            <div id="panos_outputs_add" class="collapse">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="id_panos_output_name">Variable Name:</label>
                                        <input type="text" value="" placeholder="" class="form-control"
                                               id="id_panos_output_name">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="id_panos_output_key">Capture Type:</label>
                                        <select id="id_panos_output_key" class="form-control">
                                            <option value="capture_list" selected="selected">Capture List</option>
                                            <option value="capture_pattern">Capture Pattern</option>
                                            <option value="capture_value">Capture Value</option>
                                            <option value="capture_object">Capture Object</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="id_panos_output_filter">Filter Items:</label>
                                    <input type="text" value="" class="form-control" id="id_panos_output_filter"
                                           data-modal_source="id_panos_output_key" data-modal_value="capture_list"
                                           placeholder="item == 'some_value'"
                                           title="Boolean Expression where only passing items will be added to the captured list">
                                </div>
                                <div class="form-group">
                                    <label for="id_panos_output_value">XPath Query:</label>
                                    <input type="text" value="" placeholder="" class="form-control"
                                           id="id_panos_output_value"
                                           title="Query used to find and return values from the output of this snippet.">
                                </div>
                                <button class="float-right btn btn-outline-primary"
                                        title="Add Output Definition"
                                        onclick="add_new_output('panos')">
                                    <i class="fa fa-plus"></i> Add Output to List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary"
                            onclick="update_and_edit_next_snippet('panos')">Update and Next
                    </button>
                    <button type="button" class="btn btn-primary" onclick="update_panos_snippet()"
                            data-dismiss="modal">Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit REST Snippet Modal -->
    <div class="modal fade" id="edit_rest_snippet_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_rest_snippet_label"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_rest_snippet_modal_label">Edit REST Snippet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <div class="form-group">
                        <label for="id_rest_snippet_name">Name:</label>
                        <input type="hidden" value="" id="id_rest_snippet_name">
                        <input type="text" value="" class="form-control"
                            id="id_rest_snippet_new_name">
                        <label for="id_rest_snippet_path">Path:</label>
                        <input type="text" value="" class="form-control" id="id_rest_snippet_path">
                        <label for="id_rest_snippet_operation">Operation:</label>
                        <select class="form-control" id="id_rest_snippet_operation">
                            <option>get</option>
                            <option>post</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_rest_snippet_element">element:</label>
                        <textarea class="form-control" id="id_rest_snippet_element"
                                  data-modal_source="id_rest_snippet_operation" data-modal_value="post"></textarea>
                        <p class="small muted text-right m-0">
                            <a href="#" onclick="enlarge_text_area('id_rest_snippet_element')">
                                <i class="fa fa-edit"></i>
                            </a>
                        </p>
                    </div>
                    <hr/>
                    <div class="form-group">
                        <label for="id_rest_snippet_output_type">Output Type:</label>
                        <select id="id_rest_snippet_output_type" class="form-control">
                            <option selected>xml</option>
                            <option>json</option>
                            <option>text</option>
                        </select>
                    </div>

                    <!-- Outputs -->
                    <div class="form-group">
                        <label for="all_rest_output_options">Outputs:</label>
                        <div class="input-group" id="all_rest_output_options"></div>
                    </div>
                    <a href="#rest_outputs_add" data-toggle="collapse" data-target="#rest_outputs_add"
                       aria-expanded="true" aria-controls="rest_outputs_add">
                        <i class="fa fa-plus"></i>Add Output
                    </a>
                    <div id="rest_outputs_add" class="form-group collapse">
                        <label for="id_rest_output_name">Variable Name:</label>
                        <input type="text" value="" placeholder="" class="form-control"
                               id="id_rest_output_name">
                        <label for="id_rest_output_key">Capture Type:</label>
                        <select id="id_rest_output_key" class="form-control">
                            <option value="capture_pattern">Capture Pattern</option>
                        </select>
                        <label for="id_rest_output_value">Pattern:</label>
                        <div class="input-group">
                            <input type="text" value="" placeholder="" class="form-control"
                                   id="id_rest_output_value">
                            <div class="input-group-append">
                                <span class="input-group-text">
                                    <a href="#" onclick="add_new_output('rest');">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary"
                            onclick="update_and_edit_next_snippet('rest')">Update and Next
                    </button>
                    <button type="button" class="btn btn-primary" onclick="update_snippet('rest')"
                            data-dismiss="modal">Update
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- Edit Template Snippet Modal -->
    <div class="modal fade" id="edit_template_snippet_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_template_snippet_label"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_template_snippet_modal_label">Edit Template Snippet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <div class="form-group">
                        <label for="id_template_snippet_name">Name:</label>
                        <input type="hidden" value="" id="id_template_snippet_name">
                        <input type="text" value="" class="form-control"
                            id="id_template_snippet_new_name">
                        <label for="id_template_snippet_element">Template:</label>
                        <textarea class="form-control" rows="7" id="id_template_snippet_element"></textarea>
                        <p class="small muted text-right m-0">
                            <a href="#" onclick="enlarge_text_area('id_template_snippet_element')">
                                <i class="fa fa-edit"></i>
                            </a>
                        </p>
                    </div>
                    <hr/>
                    <div class="form-group">
                        <label for="id_template_snippet_output_type">Output Type:</label>
                        <select id="id_template_snippet_output_type" class="form-control">
                            <option selected>xml</option>
                            <option>json</option>
                            <option>text</option>
                        </select>
                    </div>


                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="update_snippet('template')"
                            data-dismiss="modal">Update
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- Text Edit Modal -->
    <div class="modal fade" id="show_textarea_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_textarea_modal" style="z-index: 1051;"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="show_skillet_label">Edit Text</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <label for="text_area_input">Edit</label>
                    <textarea class="form-control text-monospace small mb-3"
                              style="width: 1200px; font-size: 80%" rows="20" id="text_area_input"></textarea>
                    <input type="hidden" id="text_area_target" value=""/>
                    <label for="text_area_input_find_replace">Create Variable from all occurrences of text</label>
                    <div class="input-group mb-3" id="text_area_input_find_replace">
                        <input type="text" placeholder="Text to Replace" id="text_area_input_find"
                               class="form-control"/>
                        <div class="input-group-append"><span class="input-group-text">:</span></div>
                        <input type="text" placeholder="Variable Name" id="text_area_input_replace"
                               class="form-control"/>
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <a href="#" onclick="text_area_find_replace();">
                                    <i class="fa fa-exchange-alt"></i>
                                </a>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="update_text_area_source()"
                            data-dismiss="modal">Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit PAN-OS Validation Snippet Modal -->
    <div class="modal fade" id="edit_pan_validation_snippet_modal" tabindex="-1" role="dialog"
         aria-labelledby="edit_pan_validation_snippet_label"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit_pan_validation_snippet_modal_label">
                        Edit PAN-OS Validation Snippet
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <ul class="nav nav-tabs" id="id_pan_validation_tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="pan_validation_main_tab" data-toggle="tab"
                               href="#pan_validation_main" role="tab"
                               aria-controls="pan_validation_main"
                               aria-selected="true">Snippet</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pan_validation_when_tab" data-toggle="tab"
                               href="#pan_validation_when" role="tab"
                               aria-controls="pan_validation_when"
                               aria-selected="false">When</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pan_validation_output_tab" data-toggle="tab"
                               href="#pan_validation_output" role="tab"
                               aria-controls="pan_validation_output"
                               aria-selected="false">Outputs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pan_validation_messages_tab" data-toggle="tab"
                               href="#pan_validation_messages" role="tab"
                               aria-controls="pan_validation_messages"
                               aria-selected="false">Messages</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pan_validation_tags_tab" data-toggle="tab"
                               href="#pan_validation_tags" role="tab"
                               aria-controls="pan_validation_tags"
                               aria-selected="false">Tags</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="pan_validation_snippet_tab">
                        <div class="tab-pane fade show active" id="pan_validation_main" role="tabpanel"
                             aria-labelledby="pan_validation_main_tab">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="id_pan_validation_snippet_name">Name:</label>
                                    <input type="hidden" value="" id="id_pan_validation_snippet_name">
                                    <input type="text" value="" class="form-control"
                                           id="id_pan_validation_snippet_new_name">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="id_pan_validation_snippet_cmd">Cmd:</label>
                                    <select id="id_pan_validation_snippet_cmd" class="form-control">
                                        <option selected>validate</option>
                                        <option>parse</option>
                                        <option>cli</option>
                                        <option>op</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="id_pan_validation_snippet_label">Label:</label>
                                <input type="text" value="" class="form-control" id="id_pan_validation_snippet_label">


                                <label for="id_pan_validation_snippet_documentation_link">Documentation Link:</label>
                                <input type="text" value="" class="form-control"
                                       id="id_pan_validation_snippet_documentation_link">
                                <label for="id_pan_validation_snippet_test">Test:</label>
                                <textarea class="form-control" rows="4" id="id_pan_validation_snippet_test"
                                          data-modal_source="id_pan_validation_snippet_cmd"
                                          data-modal_value="validate"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" onclick="enlarge_text_area('id_pan_validation_snippet_test')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                            </div>

                            <!-- cli cmd -->
                            <div class="form-group">
                                <label for="id_pan_validation_snippet_cmd_cmd_str">CLI:</label>
                                <input type="text" value="" class="form-control"
                                       id="id_pan_validation_snippet_cmd_cmd_str"
                                       data-modal_source="id_pan_validation_snippet_cmd" data-modal_value="cli">
                            </div>

                            <!-- op cmd -->
                            <div class="form-group">
                                <label for="id_pan_validation_snippet_cmd_op">Operational Command XML:</label>
                                <input type="text" value="" class="form-control"
                                       id="id_pan_validation_snippet_cmd_op"
                                       data-modal_source="id_pan_validation_snippet_cmd" data-modal_value="op">
                                <label for="id_pan_validation_snippet_op_parse_result">Parse Result:</label>
                                <select id="id_pan_validation_snippet_op_parse_result" class="form-control"
                                        title="Attempt to parse the returned XML document">
                                    <option selected>True</option>
                                    <option>False</option>
                                </select>
                            </div>

                            <!-- parse cmd -->
                            <div class="form-group">
                                <label for="id_pan_validation_snippet_variable">Parsed Variable:</label>
                                <input type="text" value="" class="form-control" id="id_pan_validation_snippet_variable"
                                       data-modal_source="id_pan_validation_snippet_cmd" data-modal_value="parse">
                            </div>
                        </div>

                        <!-- pan_validation when tab -->
                        <div class="tab-pane fade" id="pan_validation_when" role="tabpanel"
                             aria-labelledby="pan_validation_when_tab">
                            <div class="form-group">
                                <label for="id_pan_validation_snippet_when">When:</label>
                                <textarea class="form-control" rows="1" id="id_pan_validation_snippet_when"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" onclick="enlarge_text_area('id_pan_validation_snippet_when')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                            </div>
                        </div>

                        <!-- pan_validation output tab  -->
                       <div class="tab-pane fade" id="pan_validation_output" role="tabpanel"
                             aria-labelledby="pan_validation_output_tab">
                           <div class="form-group">
                               <p class="text-danger p-5 text-center"
                                  data-modal_source="id_pan_validation_snippet_cmd"
                                  data-modal_value="validate">
                                   Outputs are not currently used for validate command.
                               </p>
                           </div>

                           <div class="form-group">
                               <label for="all_pan_validation_output_options">Outputs:</label>
                               <div class="input-group" id="all_pan_validation_output_options"></div>
                               <hr/>
                               <a href="#pan_validation_outputs_add" data-toggle="collapse"
                                  data-target="#pan_validation_outputs_add"
                                  data-modal_source="id_pan_validation_snippet_cmd"
                                  data-modal_value="cli,op,parse"
                                  aria-expanded="true" aria-controls="pan_validation_outputs_add">
                                   <i class="fa fa-plus"></i>Add Output
                               </a>
                           </div>

                           <div id="pan_validation_outputs_add" class="collapse">
                                    <div class="form-row">
                                        <div class="col-md-6">
                                            <label for="id_pan_validation_output_name">Variable Name:</label>
                                            <input type="text" value="" placeholder="" class="form-control"
                                                   id="id_pan_validation_output_name">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="id_pan_validation_output_key">Capture Type:</label>
                                            <select id="id_pan_validation_output_key" class="form-control">
                                                <option value="capture_list" selected="selected">Capture List</option>
                                                <option value="capture_pattern">Capture Pattern</option>
                                                <option value="capture_value">Capture Value</option>
                                                <option value="capture_object">Capture Object</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="id_pan_validation_output_filter">Filter Items:</label>
                                        <input type="text" value="" class="form-control"
                                               id="id_pan_validation_output_filter"
                                               placeholder="item == 'some_value'"
                                               data-modal_source="id_pan_validation_output_key"
                                               data-modal_value="capture_list"
                                               title="Boolean Expression where only passing items will be added to the captured list">
                                    </div>
                                    <div class="form-group">
                                        <label for="id_pan_validation_output_value">Pattern:</label>
                                        <input type="text" value="" placeholder="" class="form-control"
                                               id="id_pan_validation_output_value">
                                    </div>
                                    <button class="float-right btn btn-outline-primary"
                                            title="Add Output Definition"
                                            onclick="add_new_output('pan_validation')">
                                        <i class="fa fa-plus"></i> Add Output to List
                                    </button>
                                </div>
                        </div>
                        
                       <!-- pan_validation messages tag -->
                        <div class="tab-pane fade" id="pan_validation_messages" role="tabpanel"
                             aria-labelledby="pan_validation_messages_tab">
                            <div class="form-group">
                                <label for="id_pan_validation_snippet_severity">Severity:</label>
                                <select id="id_pan_validation_snippet_severity" class="form-control"
                                        data-modal_source="id_pan_validation_snippet_cmd"
                                        data-modal_value="validate">
                                    <option selected>low</option>
                                    <option>medium</option>
                                    <option>high</option>
                                </select>
                                <label for="id_pan_validation_snippet_pass_message">Pass Message:</label>
                                <textarea class="form-control" rows="2"
                                          id="id_pan_validation_snippet_pass_message"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" onclick="enlarge_text_area('id_pan_validation_snippet_pass_message')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                                <label for="id_pan_validation_snippet_fail_message">Fail Message:</label>
                                <textarea class="form-control" rows="2"
                                          id="id_pan_validation_snippet_fail_message"></textarea>
                                <p class="small muted text-right m-0">
                                    <a href="#" onclick="enlarge_text_area('id_pan_validation_snippet_fail_message')">
                                        <i class="fa fa-edit"></i>
                                    </a>
                                </p>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="pan_validation_tags" role="tabpanel"
                             aria-labelledby="pan_validation_tags_tab">
                            <div class="text-right mt-1">
                                <a href="#pan_validation_tags_help" data-toggle="collapse" title="Tags Help">
                                    <i class="fa fa-question-circle"></i>
                                </a>
                            </div>
                            <div class="card card-body collapse mt-2 mb-2 bg-light" id="pan_validation_tags_help">
                                Tags allow grouping like snippets together. This is useful for sorting outputs,
                                including or excluding groups of snippets or adding additional information to the
                                user.
                            </div>
                            <div class="form-group">
                                <div class="input-group" id="all_pan_validation_tags"></div>
                                <div class="input-group" id="pan_validation_tags_add_ui">
                                    <input type="text" value="" placeholder="tag" class="form-control"
                                           id="id_pan_validation_tag">
                                    <div class="input-group-append">
                                        <span class="input-group-text">
                                            <a href="#" onclick="add_new_tag('pan_validation');">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary"
                            onclick="update_and_edit_next_snippet('pan_validation')">Update and Next
                    </button>
                    <button type="button" class="btn btn-primary" onclick="update_pan_validation_snippet()"
                            data-dismiss="modal">Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Snippet Modal -->
    <div class="modal fade" id="show_new_snippet_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_new_snippet_modal"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="show_skillet_label">New Snippet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <label for="id_new_snippet_name">Name:</label>
                    <input type="text" value="" class="form-control" id="id_new_snippet_name">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="add_new_snippet()"
                            data-dismiss="modal">Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Skillet Modal -->
    <div class="modal fade" id="show_test_skillet_modal" tabindex="-1" role="dialog"
         aria-labelledby="show_test_skillet_modal"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="test_skillet_label">Test Skillet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="overflow-y: auto">
                    <p class="card-text">
                        This tool will allow you to step through the execution of this skillet snippet by snippet
                        using the provided context. Each snippet can add to the context which will be
                        passed to the next skillet. This is a great place to
                        explore output capturing and other syntax options before saving your skillet.
                    </p>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="id_test_skillet_raw_json">Snippet:</label>
                            <textarea class="form-control" rows="8" id="id_test_skillet_raw_json"></textarea>

                        </div>
                        <div class="form-group col-md-6">
                           <label for="id_test_skillet_context">Context:</label>
                            <textarea class="form-control" rows="8" id="id_test_skillet_context"></textarea>
                            <p class="small muted text-right m-0">
                                <a href="#" onclick="enlarge_text_area('id_test_skillet_context')">
                                    <i class="fa fa-edit"></i>
                                </a>
                            </p>
                            <p class="small text-muted">
                                *Note the device configuration is always added to the context as the 'config' variable,
                                however it is filtered out in this view for brevity.
                            </p>
                            <input type="hidden" id="id_test_skillet_results"/>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6">
                            <label for="id_test_skillet_outputs">Outputs:</label>
                            <textarea class="form-control" rows="8" id="id_test_skillet_outputs"></textarea>
                            <p class="small muted text-right m-0">
                                <a href="#" onclick="enlarge_text_area('id_test_skillet_outputs')">
                                    <i class="fa fa-edit"></i>
                                </a>
                            </p>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="id_test_skillet_next">Step Through Snippets:</label>
                            <div class="input-group mb-3">
                                <input type="text" value="" disabled="disabled"
                                       class="form-control disabled" id="id_test_skillet_next">
                                <div class="input-group-append" id="start_over_skillet_button">
                                    <span class="input-group-text" title="Start Over">
                                        <a href="#" onclick="step_over_restart_skillet();">
                                            <i class="fa fa-redo"></i>
                                        </a>
                                    </span>
                                </div>
                                <div class="input-group-append" id="step_over_next_button">
                                    <span class="input-group-text" title="Skip Next Snippet">
                                        <a href="#" onclick="step_over_skillet_next();">
                                            <i class="fa fa-forward"></i>
                                        </a>
                                    </span>
                                </div>
                                <div class="input-group-append" id="step_over_skillet_button">
                                    <span class="input-group-text" title="Execute Next Snippet">
                                        <a href="#" onclick="step_over_skillet();">
                                            <i class="fa fa-play"></i>
                                        </a>
                                    </span>
                                </div>
                            </div>
                             <label for="id_test_skillet_skip_to">Skip Ahead to Snippet:</label>
                            <div class="input-group mb-3">
                                <select id="id_test_skillet_skip_to" onchange="step_over_snippet_skip_to();">
                                    <option>None</option>
                                </select>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Dismiss</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Snippet Modal -->
        <div class="modal fade" id="show_test_snippet_modal" tabindex="-1" role="dialog"
             aria-labelledby="show_test_snippet_modal"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="test_snippet_label">Test Snippet</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto">
                        <p class="card-text">
                            This will execute the snippet using the provided context. This is a great place to
                            explore output capturing and other syntax options before saving your snippet.
                        </p>
                        <label for="id_test_snippet_context">Context:</label>
                        <textarea class="form-control" rows="5" id="id_test_snippet_context"></textarea>
                        <p class="small muted text-right m-0">
                            <a href="#" onclick="enlarge_text_area('id_test_snippet_context')">
                                <i class="fa fa-edit"></i>
                            </a>
                        </p>
                        <input type="hidden" id="id_test_snippet_results"/>
                        <input type="hidden" id="id_test_snippet_snippet_name"/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal"
                                onclick="cancel_test_snippet();">Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="test_snippet()">Test
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Skillet Results Modal -->
        <div class="modal fade" id="show_test_skillet_results_modal" tabindex="-1" role="dialog"
             aria-labelledby="show_test_skillet_results_modal"
             aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="test_skillet_results_label">Test Skillet Results</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto">
                        <p class="card-text">
                            Here are the results of the Skillet Test. There are two keys shown here: 'output' and
                            'context'.
                            Output is the raw output from the Skillet itself, including any captured outputs. Context
                            shows
                            you the skillet context that was used during execution. This may include outputs and
                            ephemeral
                            computed values.
                        </p>
                        <label for="id_test_skillet_results_context">Skillet Output:</label>
                        <pre><code class="json" id="id_test_skillet_results_code"></code></pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Done</button>
                    </div>
                </div>
            </div>
        </div>

{% endblock %}